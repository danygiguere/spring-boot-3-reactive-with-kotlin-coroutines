# Spring boot 3 reactive with Kotlin coroutines and r2dbc

## About
- This project is just a demo or a starting template to work with Spring boot 3 with Kotlin coroutines and r2dbc and DatabaseClient (https://docs.spring.io/spring-framework/reference/data-access/r2dbc.html)
- The project is set up to work mysql (you can clone this project to create a dockerized db: https://github.com/danygiguere/docker_db)
- If you are using IntelliJ Ultimate, you can run the requests.http file (in the test folder) to test all the available routes
- In this demo I haven't used an orm. If you'd like to use an ORM, have a look at CoroutineCrudRepository. It' is a non-blocking reactive interface for generic CRUD operations using Kotlin Coroutines.
- I recommend you watch this video regarding coroutines : https://www.youtube.com/watch?v=ahTXElHrV0c

### The app demonstrates:
    - how to create controllers, dtos, entities, and repositories with Kotlin coroutines
    - how to set up Flyway to manage migrations
    - how to set an exception handler to manage failed validations
    - how to return translated validation error messages
    - how to create custom validators
    - how to set up the Security with JWT with an httpOnly cookie
    - how to use webfilters to block user from updating data that doesn't belong to them (checkPostOwnershipWebFilter)
    - how to do a oneToMany relationship query
    - how to do a belongsTo relationship query
    - how to do a hasManyThrough relationship query
    - how to run suspend functions in parallel with async/await
    - how to create unit tests in a reactive context
    - how to do webclient calls with Kotlin Coroutines
    - how to create Fixtures and factories to seed the db, and to create dtos data for tests
    - how to run the project in a Docker container using docker-compose (you need to make a copy of .env.example and rename the copy to .env, add your db credentials and then run docker-compose up)

### Installation
    - Add your credentials in the application-secrets.yml file
    - Start the project with ./gradlew bootRun or ./gradlew bootRun -Dspring.profiles.active=local

### Docker
    - This project has a Dockerfile and a docker-compose.yml for deployement on AWS ECS
    - To test locally, you can add the credentials in the .env file and run docker-compose up

## AWS Deployment

### ASW ECS (Serverless Fargate) instructions
    - Make sure you have the AWS CLI installed on your machine
    - run gradle clean build
    - to build the image, run docker buildx build --no-cache --pull --platform linux/amd64 -t imagename . 
    - Create an ECR repository and look at the instructions (by clicking on the view push commands button) to push the image to ECR 
        - docker buildx build --no-cache --pull --platform linux/amd64 -t imagename . 
        - aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.us-east-1.amazonaws.com
        - docker tag imagename:latest 123456789012.dkr.ecr.us-east-1.amazonaws.com/imagename:latest
        - docker push 123456789012.dkr.ecr.us-east-1.amazonaws.com/imagename:latest
    - Create a task definition in ECS
        - https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html
        - Basically, you need to enter a name, the image url (from ECR), the app port and the Environment variables (the ones in the .env)
    - Create a cluster in ECS
        - https://docs.aws.amazon.com/AmazonECS/latest/developerguide/create-a-cluster.html
        - The name is automatically generated by the ECS service, so you only need to click create cluster and then click create.

### Maintaining a Static IP Address with ECS
    - By default, ECS assigns a new IP address each time a service is created. To maintain a static IP address, you need to use a Network Load Balancer (NLB) with an Elastic IP address.

    1. Create an Elastic IP (EIP):
        - Go to the EC2 Dashboard in the AWS Console
        - In the left navigation pane, under Network & Security, click "Elastic IPs"
        - Click "Allocate Elastic IP address"
        - Select "Amazon's pool of IPv4 addresses" and click "Allocate"
        - Note the allocated Elastic IP address

    2. Create a Network Load Balancer (NLB):
        - Go to the EC2 Dashboard in the AWS Console
        - In the left navigation pane, under Load Balancing, click "Load Balancers"
        - Click "Create Load Balancer"
        - Select "Network Load Balancer" and click "Create"
        - Configure the load balancer:
            - Name: Give your load balancer a name
            - Scheme: Select "internet-facing"
            - IP address type: Select "ipv4"
            - VPC: Select the same VPC as your ECS cluster
            - Mappings: Select the subnets where your ECS tasks will run
            - For each subnet, click "Use an Elastic IP address" and select the Elastic IP you created
        - Configure the listener:
            - Protocol: TCP
            - Port: Enter the port your application listens on (e.g., 8080)
        - Configure the target group:
            - Target type: Select "IP addresses"
            - Name: Give your target group a name
            - Protocol: TCP
            - Port: Enter the port your application listens on (e.g., 8080)
            - VPC: Select the same VPC as your ECS cluster
            - Health check settings: Configure as needed
        - Click "Create load balancer"

    3. Create a service in ECS with the Network Load Balancer:
        - https://docs.aws.amazon.com/AmazonECS/latest/developerguide/create-service.html
        - To create a service, go to the task definition page, click your definition, then click Deploy and Create service
        - Choose the latest task definition
        - Under Networking, select "Application Load Balancer" or "Network Load Balancer"
        - Select the Network Load Balancer you created
        - Select the target group you created
        - Complete the rest of the service configuration as needed
        - Click "Create"

    - Now, your ECS service will always be accessible via the Elastic IP address you allocated, even if the underlying tasks are replaced or the service is recreated.
    - Note: Using a Network Load Balancer with an Elastic IP will incur additional costs. Check the AWS pricing page for details.

### Manual Setup (Without Static IP)
    - Create a service in ECS
        - https://docs.aws.amazon.com/AmazonECS/latest/developerguide/create-service.html
        - To create a service, go to the task definition page, click your definition, then click Deploy and Create service
        - Choose the lastes task definition, under Compute configuration (advanced), click the Launch type Compute Options. Under Desired tasks, choose 0 and then click create.
        - Once the service is created, you can go to the ECS dashboard, click on the cluster, then click on the service
        - From there you can see the logs and if you click on the Tasks tab, you can see the status of the task and stop it if needed
        - If you click on the task, you'll find the app Public IP under Configuration but you won't be able to acces it yet from the internet
        - Go to the Configuration and networking tab and then on the security groups link
        - Then click on the Edit inbound rules link
        - Then click on the add rule link
        - Choose Custom TCP and enter the app port and under source, choose Anywhere-IPv4
        - Create another rule but for Anywhere-IPv6
        - You should now be able to access the Public IP from the internet
        - Note: With this setup, the IP address will change each time the service is recreated.
