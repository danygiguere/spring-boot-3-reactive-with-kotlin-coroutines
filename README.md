# Spring boot 3 reactive with Kotlin coroutines and r2dbc

## About
- This project is just a demo or a starting template to work with Spring boot 3 with Kotlin coroutines and r2dbc and DatabaseClient (https://docs.spring.io/spring-framework/reference/data-access/r2dbc.html)
- The project is set up to work mysql (you can clone this project to create a dockerized db: https://github.com/danygiguere/docker_db)
- If you are using IntelliJ Ultimate, you can run the requests.http file (in the test folder) to test all the available routes
- In this demo I haven't used an orm. If you'd like to use an ORM, have a look at CoroutineCrudRepository. It' is a non-blocking reactive interface for generic CRUD operations using Kotlin Coroutines.
- I recommend you watch this video regarding coroutines : https://www.youtube.com/watch?v=ahTXElHrV0c

### The app demonstrates:
    - how to create controllers, dtos, entities, and repositories with Kotlin coroutines
    - how to set up Flyway to manage migrations
    - how to set an exception handler to manage failed validations
    - how to return translated validation error messages
    - how to create custom validators
    - how to set up the Security with JWT with an httpOnly cookie
    - how to use webfilters to block user from updating data that doesn't belong to them (checkPostOwnershipWebFilter)
    - how to do a oneToMany relationship query
    - how to do a belongsTo relationship query
    - how to do a hasManyThrough relationship query
    - how to run suspend functions in parallel with async/await
    - how to create unit tests in a reactive context
    - how to do webclient calls with Kotlin Coroutines
    - how to create Fixtures and factories to seed the db, and to create dtos data for tests
    - how to run the project in a Docker container using docker-compose (you need to make a copy of .env.example and rename the copy to .env, add your db credentials and then run docker-compose up)

### Installation
    - Add your credentials in the application-secrets.yml file
    - Start the project with ./gradlew bootRun or ./gradlew bootRun -Dspring.profiles.active=local

### Docker
    - This project has a Dockerfile and a docker-compose.yml for deployement on AWS ECS
    - To test locally, you can add the credentials in the .env file and run docker-compose up

## AWS Deployment

### ASW ECS (Serverless Fargate) instructions
    - Make sure you have the AWS CLI installed on your machine
    - run gradle clean build
    - to build the image, run docker buildx build --no-cache --pull --platform linux/amd64 -t imagename . 
    - Create an ECR repository and look at the instructions (by clicking on the view push commands button) to push the image to ECR 
        - docker buildx build --no-cache --pull --platform linux/amd64 -t imagename . 
        - aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.us-east-1.amazonaws.com
        - docker tag imagename:latest 123456789012.dkr.ecr.us-east-1.amazonaws.com/imagename:latest
        - docker push 123456789012.dkr.ecr.us-east-1.amazonaws.com/imagename:latest
    - Create a task definition in ECS
        - https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html
        - Basically, you need to enter a name, the image url (from ECR), the app port and the Environment variables (the ones in the .env)
    - Create a cluster in ECS
        - https://docs.aws.amazon.com/AmazonECS/latest/developerguide/create-a-cluster.html
        - The name is automatically generated by the ECS service, so you only need to click create cluster and then click create.

### Maintaining a Static IP Address with ECS (Using Network Load Balancer)
    - By default, ECS assigns a new IP address each time a service is created. To maintain a static IP address, you need to use a Network Load Balancer (NLB) with an Elastic IP address.

    1. Create an Elastic IP (EIP):
        - Go to the EC2 Dashboard in the AWS Console
        - In the left navigation pane, under Network & Security, click "Elastic IPs"
        - Click "Allocate Elastic IP address"
        - Select "Amazon's pool of IPv4 addresses" and click "Allocate"
        - Note the allocated Elastic IP address

    2. Create a Network Load Balancer (NLB):
        - Go to the EC2 Dashboard in the AWS Console
        - In the left navigation pane, under Load Balancing, click "Load Balancers"
        - Click "Create Load Balancer"
        - Select "Network Load Balancer" and click "Create"
        - Configure the load balancer:
            - Name: Give your load balancer a name
            - Scheme: Select "internet-facing"
            - IP address type: Select "ipv4"
            - VPC: Select the same VPC as your ECS cluster
            - Mappings: Select the subnets where your ECS tasks will run
            - For each subnet, click "Use an Elastic IP address" and select the Elastic IP you created
        - Configure the listener:
            - Protocol: TCP
            - Port: Enter the port your application listens on (e.g., 8080)
        - Configure the target group:
            - Target type: Select "IP addresses"
            - Name: Give your target group a name
            - Protocol: TCP
            - Port: Enter the port your application listens on (e.g., 8080)
            - VPC: Select the same VPC as your ECS cluster
            - Health check settings: Configure as needed
        - Click "Create load balancer"

    3. Create a service in ECS with the Network Load Balancer:
        - https://docs.aws.amazon.com/AmazonECS/latest/developerguide/create-service.html
        - To create a service, go to the task definition page, click your definition, then click Deploy and Create service
        - Choose the latest task definition
        - Under Networking, select "Application Load Balancer" or "Network Load Balancer"
        - Select the Network Load Balancer you created
        - Select the target group you created
        - Complete the rest of the service configuration as needed
        - Click "Create"

    - Now, your ECS service will always be accessible via the Elastic IP address you allocated, even if the underlying tasks are replaced or the service is recreated.
    - Note: Using a Network Load Balancer with an Elastic IP will incur additional costs. Check the AWS pricing page for details.

### Using Application Load Balancer with a Static IP for Angular and Spring Boot Apps
    - Application Load Balancers (ALBs) don't directly support Elastic IPs like Network Load Balancers do. However, there are two approaches to use an ALB with a static IP when you have both Angular (port 80) and Spring Boot (port 8080) apps on the same ECS service:

    #### Option 1: Use AWS Global Accelerator with ALB (Recommended)
    1. Create an Application Load Balancer:
        - Go to the EC2 Dashboard in the AWS Console
        - In the left navigation pane, under Load Balancing, click "Load Balancers"
        - Click "Create Load Balancer"
        - Select "Application Load Balancer" and click "Create"
        - Configure the load balancer:
            - Name: Give your load balancer a name
            - Scheme: Select "internet-facing"
            - IP address type: Select "ipv4"
            - VPC: Select the same VPC as your ECS cluster
            - Mappings: Select at least two subnets in different Availability Zones
        - Configure security settings (add HTTPS if needed)
        - Configure security groups to allow traffic on ports 80 and 8080
        - Configure routing:
            - Create two target groups:
                1. For Angular app (HTTP:80)
                2. For Spring Boot app (HTTP:8080)
        - Configure listeners:
            - Add a listener for HTTP:80 pointing to the Angular target group
            - Add a listener for HTTP:8080 pointing to the Spring Boot target group
        - Create the load balancer

    2. Set up path-based routing (optional but recommended):
        - You can configure path-based routing rules to direct traffic based on URL paths:
            - Requests to "/" or "/app/*" → Angular app (port 80)
            - Requests to "/api/*" → Spring Boot app (port 8080)

    3. Create a Global Accelerator:
        - Go to the Global Accelerator console
        - Click "Create accelerator"
        - Provide a name for your accelerator
        - Leave IP address type as IPv4
        - For Client Affinity, select "Source IP" (recommended for web applications)
            - Choose "Source IP" if your application needs to maintain session state or if the same client should be routed to the same endpoint
            - Choose "None" if you don't need session stickiness and want to optimize for performance
        - Click "Next"
        - Add a listener:
            - For ports, add 80 and 8080 (or whatever ports your applications use)
            - Protocol: TCP
        - Click "Next"
        - Add endpoint groups:
            - Select the region where your ALB is deployed
            - Click "Next"
        - Add endpoints:
            - Endpoint type: Select "Application Load Balancer"
            - Select your ALB from the dropdown
            - Click "Create accelerator"

    4. Create a service in ECS with the Application Load Balancer:
        - Follow the same steps as with the NLB, but select "Application Load Balancer" under Networking
        - Configure the service to use the target groups you created

    - With this setup, Global Accelerator provides static IP addresses that route traffic to your ALB, which then routes to the appropriate application based on port or path.

    5. Maintaining the same static IPs across deployments:
        - One of the key benefits of Global Accelerator is that it provides static IP addresses that persist regardless of your underlying infrastructure changes
        - These static IPs are assigned when you first create the accelerator and remain the same for the lifetime of the accelerator
        - To maintain the same static IPs across deployments:
            - Never delete your Global Accelerator - only update its configuration
            - When deploying new versions of your application:
                1. Push your new Docker image to ECR
                2. Update your ECS task definition with the new image
                3. Update your ECS service to use the new task definition
                4. The Global Accelerator will automatically route traffic to the new tasks as they become healthy
            - If you need to update your ALB configuration:
                1. Make the necessary changes to your existing ALB
                2. The Global Accelerator will continue to use the same ALB, preserving your static IPs
            - If you absolutely must create a new ALB:
                1. Create the new ALB
                2. Update your existing Global Accelerator to point to the new ALB (don't create a new accelerator)
                3. In the Global Accelerator console, select your accelerator
                4. Click "Listeners" and then select your listener
                5. Click "Endpoint groups" and then select your endpoint group
                6. Click "Edit" and update the endpoint to point to your new ALB
                7. Click "Save changes"
        - Important: The static IPs are tied to the Global Accelerator itself, not to the underlying resources. As long as you don't delete the accelerator, your static IPs will remain the same.

    #### Option 2: Use NLB in front of ALB
    1. Create an Application Load Balancer as described in Option 1

    2. Create a Network Load Balancer with Elastic IP:
        - Follow the steps in the "Maintaining a Static IP Address with ECS" section above
        - For the target group, instead of pointing to your ECS tasks directly:
            - Target type: Select "Application Load Balancer"
            - Select the ALB you created in step 1

    3. Create listeners on the NLB:
        - Add a listener for TCP:80 to forward to the ALB
        - Add a listener for TCP:8080 to forward to the ALB

    4. Create a service in ECS with the Application Load Balancer:
        - Configure as described in Option 1, step 4

    - This approach uses the NLB as a "pass-through" to maintain a static IP, while leveraging the ALB's advanced routing capabilities.

    #### Choosing Between Options
    - Use Option 1 (Global Accelerator) if:
        - You need global traffic management and acceleration
        - You want built-in DDoS protection
        - You're okay with having two static IPs instead of one

    - Use Option 2 (NLB in front of ALB) if:
        - You need a single, specific Elastic IP
        - You're working within a single region
        - You want a simpler setup with fewer AWS services

### Manual Setup (Without Static IP)
    - Create a service in ECS
        - https://docs.aws.amazon.com/AmazonECS/latest/developerguide/create-service.html
        - To create a service, go to the task definition page, click your definition, then click Deploy and Create service
        - Choose the lastes task definition, under Compute configuration (advanced), click the Launch type Compute Options. Under Desired tasks, choose 0 and then click create.
        - Once the service is created, you can go to the ECS dashboard, click on the cluster, then click on the service
        - From there you can see the logs and if you click on the Tasks tab, you can see the status of the task and stop it if needed
        - If you click on the task, you'll find the app Public IP under Configuration but you won't be able to acces it yet from the internet
        - Go to the Configuration and networking tab and then on the security groups link
        - Then click on the Edit inbound rules link
        - Then click on the add rule link
        - Choose Custom TCP and enter the app port and under source, choose Anywhere-IPv4
        - Create another rule but for Anywhere-IPv6
        - You should now be able to access the Public IP from the internet
        - Note: With this setup, the IP address will change each time the service is recreated.
